<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventaire Pro - Loader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        .suggestion-box { max-height: 300px; overflow-y: auto; z-index: 100; }
        .loader-overlay { background: rgba(255,255,255,0.9); backdrop-filter: blur(5px); }
    </style>
</head>
<body class="bg-slate-100 min-h-screen pb-40">

    <div id="setupScreen" class="fixed inset-0 z-[100] loader-overlay flex flex-col items-center justify-center p-6 text-center hidden">
        <div class="bg-white p-8 rounded-3xl shadow-2xl border-2 border-blue-500 max-w-sm">
            <h2 class="text-2xl font-black text-blue-800 mb-4">Initialisation</h2>
            <p class="text-sm text-gray-600 mb-6">SÃ©lectionnez vos fichiers pour activer la base de donnÃ©es.</p>
            
            <label class="block mb-4">
                <span class="text-xs font-bold uppercase text-gray-400">1. Base gÃ©nÃ©rale (.xlsx)</span>
                <input type="file" id="baseFile" accept=".xlsx, .csv" class="mt-1 block w-full text-sm border rounded-lg">
            </label>

            <label class="block mb-6">
                <span class="text-xs font-bold uppercase text-gray-400">2. Liste actuelle (.xlsx)</span>
                <input type="file" id="testFile" accept=".xlsx, .csv" class="mt-1 block w-full text-sm border rounded-lg">
            </label>

            <button onclick="processFiles()" class="w-full bg-blue-600 text-white font-bold py-4 rounded-2xl shadow-lg active:scale-95 transition">
                ACTIVER L'APPLICATION
            </button>
        </div>
    </div>

    <div class="bg-blue-800 text-white p-4 sticky top-0 shadow-lg z-50">
        <div class="flex justify-between items-center mb-3">
            <h1 class="font-black italic text-xl">INVENTAIRE</h1>
            <div class="flex gap-2">
                <button onclick="exportToExcel()" class="bg-green-600 text-[10px] font-bold py-2 px-3 rounded-lg">ðŸ’¾ EXPORT</button>
                <button onclick="resetApp()" class="bg-red-500 text-[10px] font-bold py-2 px-3 rounded-lg">ðŸ”„ RESET</button>
            </div>
        </div>
        <input type="text" id="mainSearch" oninput="renderItems()" placeholder="ðŸ” Chercher dans ma liste..." 
               class="w-full p-4 rounded-xl text-black outline-none focus:ring-4 focus:ring-yellow-400">
    </div>

    <div id="itemList" class="p-4 space-y-3"></div>

    <div class="fixed bottom-0 left-0 right-0 bg-white p-4 border-t-2 shadow-2xl z-50">
        <div class="relative">
            <input type="text" id="addSearch" oninput="showSuggestions()" placeholder="Ajouter un article de la base..." 
                   class="w-full p-4 bg-slate-100 rounded-2xl border-2 border-blue-100 focus:border-blue-500 outline-none">
            <div id="suggestionList" class="suggestion-box absolute bottom-full left-0 right-0 bg-white hidden border-2 border-blue-500 rounded-t-2xl shadow-2xl"></div>
        </div>
    </div>

    <script>
        let inventory = JSON.parse(localStorage.getItem('inv_data')) || [];
        let baseDb = JSON.parse(localStorage.getItem('base_db')) || [];

        // Afficher l'Ã©cran de config si vide
        if (inventory.length === 0) {
            document.getElementById('setupScreen').classList.remove('hidden');
        }

        async function processFiles() {
            const bFile = document.getElementById('baseFile').files[0];
            const tFile = document.getElementById('testFile').files[0];

            if (!bFile || !tFile) return alert("Veuillez sÃ©lectionner les deux fichiers.");

            // Lire la Base
            baseDb = await readExcel(bFile, row => ({
                d: `[${row.code || ''}] ${row.Nom || ''}`,
                u: row['UnitÃ© de mesure'] || 'UnitÃ©(s)'
            }));

            // Lire la Liste de Test
            inventory = await readExcel(tFile, row => ({
                id: Math.random(),
                designation: row.Designation || row.Nom,
                unit: row['UnitÃ©(s)'] || row['UnitÃ© de mesure'] || 'UnitÃ©(s)',
                qty: 0
            }));

            localStorage.setItem('base_db', JSON.stringify(baseDb));
            localStorage.setItem('inv_data', JSON.stringify(inventory));
            
            document.getElementById('setupScreen').classList.add('hidden');
            renderItems();
            alert("Application activÃ©e avec succÃ¨s !");
        }

        function readExcel(file, transformFn) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const sheet = workbook.Sheets[workbook.SheetNames[0]];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    resolve(json.map(transformFn));
                };
                reader.readAsArrayBuffer(file);
            });
        }

        function showSuggestions() {
            const val = document.getElementById('addSearch').value.toLowerCase().trim();
            const box = document.getElementById('suggestionList');
            if (val.length < 2) { box.classList.add('hidden'); return; }

            const matches = baseDb.filter(i => i.d.toLowerCase().includes(val)).slice(0, 30);
            box.classList.remove('hidden');
            box.innerHTML = matches.map(m => `
                <div onclick="addToList('${m.d.replace(/'/g, "\\'")}', '${m.u}')" class="p-4 border-b active:bg-blue-100 flex justify-between">
                    <span class="text-sm font-bold">${m.d}</span>
                    <span class="text-[10px] text-blue-600 font-black">${m.u}</span>
                </div>
            `).join('');
        }

        function addToList(d, u) {
            inventory.unshift({ id: Date.now(), designation: d, unit: u, qty: 0 });
            localStorage.setItem('inv_data', JSON.stringify(inventory));
            renderItems();
            document.getElementById('addSearch').value = "";
            document.getElementById('suggestionList').classList.add('hidden');
        }

        function renderItems() {
            const term = document.getElementById('mainSearch').value.toLowerCase();
            const list = document.getElementById('itemList');
            const filtered = inventory.filter(i => i.designation.toLowerCase().includes(term));

            list.innerHTML = filtered.map(item => `
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <div class="flex justify-between">
                        <span class="font-bold text-slate-800 text-sm">${item.designation}</span>
                        <button onclick="deleteItem(${item.id})" class="text-red-300">âœ•</button>
                    </div>
                    <div class="text-[10px] text-gray-400 font-bold uppercase mb-3">UnitÃ©: ${item.unit}</div>
                    <div class="flex items-center justify-between bg-slate-50 rounded-xl p-2">
                        <button onclick="changeQty(${item.id}, -1)" class="w-12 h-12 bg-white rounded-lg shadow text-2xl">-</button>
                        <input type="number" value="${item.qty}" onchange="updateQty(${item.id}, this.value)" class="w-20 text-center text-2xl font-black text-blue-800 bg-transparent">
                        <button onclick="changeQty(${item.id}, 1)" class="w-12 h-12 bg-blue-600 text-white rounded-lg shadow text-2xl">+</button>
                    </div>
                </div>
            `).join('');
        }

        function changeQty(id, diff) {
            const item = inventory.find(i => i.id === id);
            item.qty = Math.max(0, parseFloat((item.qty + diff).toFixed(2)));
            localStorage.setItem('inv_data', JSON.stringify(inventory));
            renderItems();
        }

        function deleteItem(id) {
            if(confirm("Supprimer ?")) {
                inventory = inventory.filter(i => i.id !== id);
                localStorage.setItem('inv_data', JSON.stringify(inventory));
                renderItems();
            }
        }

        function resetApp() {
            if(confirm("Tout effacer et rÃ©importer les fichiers ?")) {
                localStorage.clear();
                location.reload();
            }
        }

        function exportToExcel() {
            const ws = XLSX.utils.json_to_sheet(inventory);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Inventaire");
            XLSX.writeFile(wb, `Inventaire_${new Date().toLocaleDateString()}.xlsx`);
        }
    </script>
</body>
</html>
